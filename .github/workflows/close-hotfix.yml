name: Close Hotfix

on:
  workflow_dispatch:  # Permite execução manual

jobs:
  close_hotfix:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout hotfix branch
        uses: actions/checkout@v2

      - name: Merge hotfix into main
        run: |
          git checkout main
          git merge --no-ff ${{ github.ref }} || echo "Merge conflicts detected, creating PR"
          git push origin main

      - name: Create Pull Request if merge conflicts occurred
        if: failure()
        uses: peter-evans/create-pull-request@v3
        with:
          title: "Resolve conflicts for hotfix ${{ github.ref }}"
          body: |
            This PR resolves conflicts from the hotfix branch.
          base: main
          head: ${{ github.ref }}

      - name: Merge hotfix into develop
        run: |
          git checkout develop
          git merge --no-ff ${{ github.ref }} || echo "Merge conflicts detected, creating PR"
          git push origin develop

      - name: Create Pull Request if merge conflicts occurred for develop
        if: failure()
        uses: peter-evans/create-pull-request@v3
        with:
          title: "Resolve conflicts for hotfix ${{ github.ref }} (develop)"
          body: |
            This PR resolves conflicts from the hotfix branch into develop.
          base: develop
          head: ${{ github.ref }}

      - name: Criar tag e release no GitHub
        run: |
          VERSION=${{ github.ref_name }}
          git tag -a $VERSION -m "Hotfix $VERSION"
          git push origin $VERSION

      - name: Criar release no GitHub
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Hotfix ${{ github.ref_name }}
          body: "Hotfix release criada via GitHub Actions."
          draft: false
          prerelease: false
